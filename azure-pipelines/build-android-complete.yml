# File: azure-pipelines\build-android-complete.yml
# Description: Generate BrokerHost APK
#              * use <project>_branch variables to build the Local version
#              * use <project>_version variables to build the Dist version
# Variable 'common_branch' was defined in the Variables tab
# Variable 'msal_branch' was defined in the Variables tab
# Variable 'adal_branch' was defined in the Variables tab
# Variable 'ad_accounts_branch' was defined in the Variables tab
# Variable 'common_version' was defined in the Variables tab
# Variable 'msal_version' was defined in the Variables tab
# Variable 'adal_version' was defined in the Variables tab
# Variable 'ad_accounts_version' was defined in the Variables tab
name: $(date:yyyyMMdd)$(rev:.r)

trigger: none
pr: none

parameters:
- name: productFlavors
  displayName: Product Flavor
  type: string
  default: Local
  values:
  - Local
  - Dist
- name: signingConfigurations
  displayName: Signing Configuration
  type: string
  default: Debug
  values:
  - Debug
  - Release

resources:
  repositories:
  - repository: common
    type: github
    name: AzureAD/microsoft-authentication-library-common-for-android
    ref: $(common_branch)
    endpoint: ANDROID_GITHUB
  - repository: msal
    type: github
    name: AzureAD/microsoft-authentication-library-for-android
    ref: $(msal_branch)
    endpoint: ANDROID_GITHUB
  - repository: adal
    type: github
    name: AzureAD/azure-activedirectory-library-for-android
    ref: $(adal_branch)
    endpoint: ANDROID_GITHUB
  - repository: ad_accounts
    type: github
    name: AzureAD/ad-accounts-for-android
    ref: $(ad_accounts_branch)
    endpoint: ANDROID_GITHUB

jobs:
- job: brokerhost
  displayName: Build BrokerHost ${{ parameters.productFlavors }} ${{ parameters.signingConfigurations }} APK
  pool:
    name: Hosted Windows 2019 with VS2019
  steps:
  - checkout: self
    clean: true
    submodules: true
    path: $(Build.SourcesDirectory)\android-complete
  - checkout: common
    clean: true
    submodules: true
    path: $(Build.SourcesDirectory)\android-complete\common
  - checkout: msal
    clean: true
    submodules: true
    path: $(Build.SourcesDirectory)\android-complete\msal
  - checkout: adal
    clean: true
    submodules: true
    path: $(Build.SourcesDirectory)\android-complete\adal
  - checkout: ad_accounts
    clean: true
    submodules: true
    path: $(Build.SourcesDirectory)\android-complete\broker
  - ${{ if eq(parameters.productFlavors, 'Dist') }}:
    - task: PowerShell@2
      displayName: Generate Assemble Dist Task
      inputs:
        targetType: inline
        script: |
          $assembleTask = "assembleDist${{ parameters.signingConfigurations }}"
          if (("$(common_version)" -ne "")) {
              $assembleTask = $assembleTask + " -PcommonVersion=" + "$(common_version)"
          }
          if (("$(ad_accounts_version)" -ne "")) {
              $assembleTask = $assembleTask + " -PadAccountsVersion=" + "$(ad_accounts_version)"
          }
          if (("$(adal_version)" -ne "")) {
              $assembleTask = $assembleTask + " -PadalVersion=" + "$(adal_version)"
          }
          if (("$(msal_version)" -ne "")) {
              $assembleTask = $assembleTask + " -PmsalVersion=" + "$(msal_version)"
          }
          Write-Host "##vso[task.setvariable variable=AssembleTask;]$assembleTask"
  - ${{ if eq(parameters.productFlavors, 'Local') }}:
    - pwsh: echo "##vso[task.setvariable variable=AssembleTask;]assembleLocal${{ parameters.signingConfigurations }}"
      displayName: Generate Assemble Local Task
  - task: Gradle@1
    name: Gradle1
    displayName: Assemble BrokerHost
    inputs:
      tasks: brokerHost:clean brokerHost:$(AssembleTask)
      publishJUnitResults: false
      jdkArchitecture: x86
      sqAnalysisBreakBuildIfQualityGateFailed: false
      gradleWrapperFile: $(Build.SourcesDirectory)\android-complete\gradlew
      cwd: $(Build.SourcesDirectory)\android-complete
  - task: PublishBuildArtifacts@1
    displayName: Publish Broker Host APK
    inputs:
      PathtoPublish: $(Build.SourcesDirectory)\android-complete\userapp\build\outputs\apk
      ArtifactName: BrokerHost
...
