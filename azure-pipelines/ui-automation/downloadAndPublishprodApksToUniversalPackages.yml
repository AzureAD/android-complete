name: $(Build.BuildId)_$(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none
pr: none

parameters:  
  - name: brokerProdPipelineId
    type: string  
    default: 92387
  - name: brokerPackage
    type: string
    default: com.azure.authenticator
    displayName: Broker Package
  - name: brokerVersion
    displayName: Broker Version
    type: string
    default: 0.0.1

variables:
  oneProjectId: b32aa71e-8ed2-41b2-9d77-5bc261222004
  internalFeedName: OneProdBrokerApks

jobs:
  - job: 'download_and_publish'
    displayName: Download And Publish Brokers to Universal Packages
    pool:
      vmImage: ubuntu-latest
    steps:
      - checkout: none
      - task: DownloadPipelineArtifact@2
        displayName: 'Download latest Prod Broker'
        inputs:
          buildType: 'specific'
          project: '$(oneProjectId)'
          definition: '${{ parameters.brokerProdPipelineId }}'
          artifactName: MicrosoftAuthenticatorAndroid
          itemPattern: '**/app-production-universal-release-signed.apk.apk'
          targetPath: '$(Build.ArtifactStagingDirectory)/broker/prod'
          buildVersionToDownload: 'latest'
      - task: UniversalPackages@0
        displayName: 'Publish Broker Apk'
        inputs:
          command: 'publish'
          publishDirectory: '$(Build.ArtifactStagingDirectory)/broker/prod'                   
          vstsFeedPublish: '$(internalFeedName)'
          vstsFeedPackagePublish: '${{ parameters.brokerPackage }}'
          versionOption: custom
          vstsPackageVersion: '${{ parameters.brokerVersion }}'
          packagePublishDescription: 'Prod Broker APK'
...
