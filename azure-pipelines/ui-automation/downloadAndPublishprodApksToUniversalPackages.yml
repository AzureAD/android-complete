name: $(Build.BuildId)_$(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none
pr: none

parameters:  
  - name: brokerProdPipelineId
    type: string  
    default: 92387
  - name: brokerPackage
    type: string
    default: com.azure.authenticator.prod
    displayName: Broker Package
  - name: brokerVersion
    displayName: Broker Version
    type: string
    default: 0.0.1
  - name: internalFeedName
    displayName: Internal Feed Name
    type: string
    default: Android-Broker  

variables:
  oneProjectId: b32aa71e-8ed2-41b2-9d77-5bc261222004  

jobs:
  - job: 'download_and_publish'
    displayName: Download And Publish Brokers to Universal Packages
    pool:
      vmImage: ubuntu-latest
    steps:
      - checkout: none
      - task: DownloadPipelineArtifact@2
        displayName: 'Download latest Prod Broker'
        inputs:
          buildType: 'specific'
          project: '$(oneProjectId)'
          definition: '${{ parameters.brokerProdPipelineId }}'
          artifactName: MicrosoftAuthenticatorAndroid
          itemPattern: '**/app-production-universal-release-signed.apk'
          targetPath: '$(Build.ArtifactStagingDirectory)/broker/prod'
          buildVersionToDownload: 'latest'
      - task: Bash@3
        displayName: 'Renaming PROD artifact'
        inputs:
          targetType: 'inline'       
          script: |      
            cd $(Build.ArtifactStagingDirectory)/broker/prod
            mv app-production-universal-release-signed.apk app-production-universal-release-signed-PROD.apk
            
            set -o errexit    
      - task: UniversalPackages@0
        displayName: 'Publish Broker Apk'
        inputs:
          command: 'publish'
          publishDirectory: '$(Build.ArtifactStagingDirectory)/broker/prod'                   
          vstsFeedPublish: '${{ parameters.internalFeedName }}'
          vstsFeedPackagePublish: '${{ parameters.brokerPackage }}'          
          vstsPackageVersion: '${{ parameters.brokerVersion }}'
          packagePublishDescription: 'Prod Broker APK'
...
